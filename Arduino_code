#include <UniversalTelegramBot.h>
#include <WiFiClientSecure.h>
#include <ESP8266WiFi.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2);

char message[100];

#define WIFI_SSID ""//와이파이 이름
#define WIFI_PASSWORD ""//와이파이 비밀번호

#define BOT_TOKEN "8140194638:AAGOpEGxQ9Qf3nxU6sLhEFPsJLk23sPn7Jw"  //bot token
#define CHAT_ID "5561347315"     //Chat ID

#define TRIG_PIN D7
#define ECHO_PIN D6

WiFiClientSecure client;
UniversalTelegramBot bot(BOT_TOKEN, client);

void setup() {
Serial.begin(115200);

Serial.println("");
Serial.println("와이파이에 연결 중...");
WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
while (WiFi.status() != WL_CONNECTED){
  Serial.print(".");
  delay(1000);
}
Serial.println("");
Serial.println("와이파이 연결 완료.");
Serial.println();

configTime(0, 0, "pool.ntp.org");
time_t now = time(nullptr);
Serial.println("시간 동기화 중...");
while (now < 24 + 3600){
  now = time(nullptr);
  Serial.print(".");
  delay(1000);
}
Serial.println("");
Serial.println("시간 동기화 완료.");
Serial.println("");

lcd.init();
lcd.backlight();
lcd.setCursor(0, 0);
lcd.print("Distance");

pinMode(TRIG_PIN, OUTPUT);
pinMode(ECHO_PIN, INPUT);
}

void loop() {
digitalWrite(TRIG_PIN, HIGH);
delayMicroseconds(10);
digitalWrite(TRIG_PIN, LOW);

unsigned long duration = pulseIn(ECHO_PIN, HIGH);
float distanceCM = ((34000.0 * (float)duration) / 1000000.0) / 2.0;
Serial.println(distanceCM);

if (distanceCM > 2 && distanceCM < 20){
  Serial.println("물체 감지!!");
  lcd.setCursor(0, 1);
  lcd.print(distanceCM);

  if (WiFi.status() != WL_CONNECTED){
    Serial.println("WiFi에 연결이 되어있지 않아 텔레그램으로 메시지를 전송할 수 없습니다.");
  } else {
    sprintf(message, "물체가 감지되었습니다!!\n물체의 거리 : %g", distanceCM);
    Serial.println("텔레그램을 통해 문자를 보냅니다.");
    X509List cert(TELEGRAM_CERTIFICATE_ROOT);
    client.setTrustAnchors(&cert);
    bot.sendMessage(CHAT_ID, message, "");
  }

  for (int i = 0; i < 10; i++){
    delay(1000);
  }
}
delay(500);
}
